<!DOCTYPE html>
<html class="x-admin-sm">
  
  <head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.1</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
      
     <link rel="styesheet" href="./lib/layui/css/layui.css">
    <link rel="styesheet" href="./css/common.css"> 
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <style>
        input {
            height: 33px;
            line-height: 33px;
            padding: 0 7px;
            border: 1px solid #ccc;
            border-radius: 2px;
            margin-bottom: -2px;
            outline: none;
        }

        input:focus {
            border-color: #009E94;
        }
    </style>
    <script type="text/javascript" src="./js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>
    <script type="text/javascript" src="./js/cookie.js"></script>
    <script type="text/javascript" src="./js/jwt.js"></script>
    <script type="text/javascript" src="./zTree_v3/js/jquery.ztree.all.min.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  
  <body >
   <ul id="tree" class="ztree" style="width:230px; overflow:auto;"></ul>
    <div class="x-nav layui-container">
      <span class="layui-breadcrumb">
        <a href="idenx.html">首页</a>
        <a href="">演示</a>
        <a>
          <cite>导航元素</cite></a>
      </span>
      <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
        <i class="layui-icon" style="line-height:30px">ဂ</i></a>
    </div>
    <div class="x-body">
     
  
    <br><br>
    <a class="layui-btn layui-btn-normal" href="company-list1.html">&lt;&lt;返回</a>
    &nbsp;&nbsp;
    <div class="layui-btn-group">
        <button class="layui-btn" id="btn-expand">全部展开</button>
        <button class="layui-btn" id="btn-fold">全部折叠</button>
    </div>
    &nbsp;&nbsp;
    <input id="edt-search" type="text" placeholder="输入关键字" style="width: 120px;"/>&nbsp;&nbsp;
    <button class="layui-btn" id="btn-search">&nbsp;&nbsp;搜索&nbsp;&nbsp;</button>
         <span id="dataLength"></span>
    <table id="auth-table" class="layui-table" lay-filter="auth-table"></table>

       
      </table>

    </div>
    <script type="text/html" id="toolbarDemo">
      <div class="layui-btn-container">

        <button class="layui-btn layui-btn-sm" lay-event="getCheckData">新建机构</button>
<button class="layui-btn layui-btn-warm layui-btn-xs" lay-event="openAdd"	 ><i class="layui-icon">&#xe642;</i>添加子机构</button>
        <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
        <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>
      </div>
    </script>
    <script type="text/html" id="button" >
<button class="layui-btn layui-btn layui-btn-xs"  onclick="x_admin_show('编辑','admin-edit.html?id='+{{d.id}})" ><i class="layui-icon">&#xe642;</i>编辑</button>
               
              
              <button class="layui-btn-danger layui-btn layui-btn-xs"  onclick="member_del(this,{{d.id}})" href="javascript:;" ><i class="layui-icon">&#xe640;</i>删除</button></script>
    <script type="text/html" id="tdheads">
      <!-- 这里的 checked 的状态只是演示 -->
      <i class="layui-icon x-show" status='true'>&#xe623;</i>
           {{d.iname}}
    </script>
    
    <script type="text/javascript">
    var zTreeObj;
     var setting={
    		 check:{
    			 enable:true,
    			 chkStyle:'checkbox' //显示CheckBox选择框，默认checkbox可选值radio
    		 },
    		 /* callback:{
    			 onClick: //函数（callback回调函数） 
    		 }, */
    		 async:{
    			 enable:true, //开启async功能必须要设置为true，其他地方同理
    			 dataType:'json',
    			 url:'http://localhost:8080/findTree',//异步请求数据的接口
    			 type:'get'	
    		 },
    		 data:{ 
    			 key:{
    				 isParent: "parent",
    				 name:'iname'
    			 },
    			  simpleData:{ //设置节点，父节点，以及默认的根节点
    				  enable:true,
    				  idKey: "id",//节点id名
                      pIdKey: "fid",//父节点id名
                      rootPId: 0//默认根节点为0
    				  
    			  }
    		 }
    		 
    		
     };
     
     $(document).ready(function(){
         zTreeObj = $.fn.zTree.init($("#tree"), setting);
      });
    </script>
          
    <script>
    
    //动态生成树状表
    layui.config({
        base: 'module/'
    }).extend({
        treetable: 'treetable-lay/treetable'
    }).use(['table', 'treetable'], function () {
        var $ = layui.jquery;
        var table = layui.table;
        var treetable = layui.treetable;

        // 渲染表格
      /*   layer.load(2); */
        treetable.render({
        	 treeColIndex: 2,//树形图标显示在第几列
             treeSpid: 0,//最上级的父级id
             treeIdName: 'id',//id字段的名称
             treePidName: 'fid',//pid字段的名称
             treeDefaultClose: false,//是否默认折叠
             treeLinkage: true,//父级展开时是否自动展开所有子级
      	   elem:'#auth-table',
      	   url:'http://localhost:8080/findPageInstitution',
      	   headers:createAuthorizationTokenHeader(),
      	   response: {
  			    statusName: 'status' //规定数据状态的字段名称，默认：code
  			    ,statusCode: 'OK' //规定成功的状态码，默认：0
  			    ,msgName: 'msg' //规定状态信息的字段名称，默认：msg
  			    ,countName: 'count' //规定数据总数的字段名称，默认：count
  			    ,dataName: 'data' //规定数据列表的字段名称，默认：data
  			  } , 
  			  page : false, //开启分页	
  				toolbar: '#toolbarDemo',
  				request: {
  				    pageName: 'pageNoStr' //页码的参数名称，默认：page
  				    ,limitName: 'pageSizeStr',
  				     //每页数据量的参数名，默认：limit
  				  },
            cols: [[ {
            	 type:'checkbox',
           	  field:'ID'
           	  }, {
           		  field:'id',
     				templet:'<div>{{d.id}}</div>', 
     				title : 'ID',
     				width : 50,
     				
     				align : 'center',  
           	  },{
           		  field:'iname',
           		  templet:'#tdheads',
           		  title:'机构/部门名城',
           		  align : 'center',
           	  },{
           		  field:'namepath',
           		  /* templet:'<div>{{d.namepath}}</div>', */
           		  title:'机构路径',
           		  align:'center',
           	  },{field: 'fid', title:'排序',width : 70},
           	  {
           		  filed:'button',
           		  templet:'#button',
           		  title:'操作',
           		  align:'center',
           		  style:'td-manage',
           	  }
            ]],
            defaultToolbar: ['filter', 'print', 'exports'],
  			size : 'lg', 
  			done : function(res, curr, count) {
  				
  				//如果是异步请求数据方式，res即为你接口返回的信息。
  				//如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
  				//得到数据总量
  				$("#dataLength").text("共有数据：" + count + "条");
  			}
        });

        
        
        
         $('#btn-expand').click(function () {
            treetable.expandAll('#auth-table');
        });

        $('#btn-fold').click(function () {
            treetable.foldAll('#auth-table');
        }); 

        $('#btn-search').click(function () {
            var keyword = $('#edt-search').val();
            var searchCount = 0;
            $('#auth-table').next('.treeTable').find('.layui-table-body tbody tr td').each(function () {
                 $(this).css('background-color', 'transparent'); 
                var text = $(this).text();
                if (keyword != '' && text.indexOf(keyword) >= 0) {
                    $(this).css('background-color', 'rgba(250,230,160,0.5)');
                    if (searchCount == 0) {
                        treetable.expandAll('#auth-table');
                        $('html,body').stop(true);
                        $('html,body').animate({scrollTop: $(this).offset().top - 150}, 500);
                    }
                    searchCount++;
                }
            });
            if (keyword == '') {
                layer.msg("请输入搜索内容", {icon: 5});
            } else if (searchCount == 0) {
                layer.msg("没有匹配结果", {icon: 5});
            }
        });
        
       
        //监听单元格编辑
        table.on('edit(auth-table)', function(obj){
          var value = obj.value //得到修改后的值
          ,data = obj.data //得到所在行所有键值
          ,field = obj.field; //得到字段
          layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
        });

        //头工具栏事件
        table.on('toolbar(auth-table)', function(obj){
          var checkStatus = table.checkStatus(obj.config.id);
          switch(obj.event){
          case 'getCheckData':
        	  layer.prompt({
    			  formType: 2,
    			  value: '请输入机构名',
    			  title: '新增机构',
    			  area: ['200px', '70px'] //自定义文本域宽高
    			}, function(value, index, elem){
    			  alert(value); //得到value
    			  var data={
    					  "fid":0,
    					  "iname":value,
    					  "namepath":'/'+value
    			  }
    			  if(value==null||value==''||value=='请输入机构名'){
    				  layer.msg('创建失败,请重新创建！',{
						  icon:2,
						  time:2000
					  });
					  layer.close(index);
    			  }
    			  $.ajax({
    				  method:'post',
    				  url:'http://localhost:8080/institution',
    				  data:JSON.stringify(data),
    				  contentType:'application/json;charset=UTF-8',
    				  success:function(data){
    					  if(data=='ok'){
    						  layer.msg('创建成功！',{
    							  icon:1,
    							  time:2000
    						  });
    						  layer.close(index);
    					  }
    				  }
    			  });
    			  
    			  
    			});
        	  break;
            case 'getCheckLength':
              var data = checkStatus.data;
              layer.msg('选中了：'+ data.length + ' 个');
            break;
            case 'openAdd':
            	x_admin_show('新建子机构','institution-add.html','600','260');
            	break;
            case 'isAll':
              layer.msg(checkStatus.isAll ? '全选': '未全选');
            break;
          };
        }); 
        
        
        //监听增加点击事件
        table.on('tool(auth-table)',function(obj){
        	
        
        });
        
        
    });
</script>
   
    
    <script type="text/javascript">
    	function parpert (id) {
    		if(id==null||id==''||id=='0'){
    			return '无';
    		}
    		// 通过父机构的id查询父机构的名称
    		$.ajax({
    			method:'get',
    			url:'',
    			headers:'',
    			async:true,
    			success:function (data) {
    				if(data!=null){
    					return data.iname;
    				}
    			},
    		});
    		
    	}
    	
    </script>
    
   
  </body>

</html>